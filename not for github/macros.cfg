####################################################################################
##                                    Homing Override
####################################################################################
[homing_override]
axes: z
set_position_z: 0
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}


    # SAFETY: Use relative Z movement to avoid crashes
    # Relative mode moves bed DOWN (away from nozzle) regardless of actual position
    G91
    G0 Z5 F{speeds.home_z}
    G90
        # Home Y first
    G28 Y

    # Move Y off 10mm
    G91                       # Relative positioning
    G0 Y-10 {speeds.home_y}   # Move Y 20mm
    G90                       # Back to absolute positioning

    # Home X
    G28 X

    # Home Z
    G1 X{pos.center_x} Y{pos.center_y} F{speeds.center}
    G28 Z


####################################################################################
##                                  Safety Helpers
####################################################################################
#
#  CRASH PREVENTION SYSTEM
#  -----------------------
#  These macros help prevent axis crashes by:
#  1. Using relative moves when position is uncertain
#  2. Checking against axis limits before absolute moves
#  3. Providing safe Z hop regardless of current position
#
#  Key concept: On Trident, +Z = bed moves DOWN (away from nozzle)
#  So G91 + G0 Z+ is ALWAYS safe (moves bed away from nozzle)
#
####################################################################################

[gcode_macro _SAFE_ZHOP]
description: Always-safe Z hop using relative movement - bed moves DOWN (away from nozzle)
gcode:
    {% set hop = params.HOP|default(5)|float %}
    {% set speed = params.SPEED|default(1500)|float %}
    {% set max_z = printer["gcode_macro _GLOBAL_POSITIONS"].bed_z %}
    
    {% if "z" in printer.toolhead.homed_axes %}
        # Z is homed - we know where we are, check limits
        {% if printer.toolhead.position.z + hop <= max_z %}
            G91
            G0 Z{hop} F{speed}
            G90
        {% else %}
            # Would exceed max, go to max instead
            G90
            G0 Z{max_z} F{speed}
        {% endif %}
    {% else %}
        # Z not homed - use relative move (always safe direction)
        G91
        G0 Z{hop} F{speed}
        G90
    {% endif %}


[gcode_macro _SAFE_MOVE]
description: Safe absolute move with boundary checking
gcode:
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    
    {% set target_x = params.X|default(printer.toolhead.position.x)|float %}
    {% set target_y = params.Y|default(printer.toolhead.position.y)|float %}
    {% set target_z = params.Z|default(printer.toolhead.position.z)|float %}
    {% set speed = params.F|default(speeds.park)|float %}
    
    # Clamp to safe boundaries
    {% set safe_x = [[target_x, 0]|max, pos.bed_x]|min %}
    {% set safe_y = [[target_y, 0]|max, pos.bed_y]|min %}
    {% set safe_z = [[target_z, 0]|max, pos.bed_z]|min %}
    
    # Warn if clamping occurred
    {% if safe_x != target_x %}
        {action_respond_info("SAFETY: X clamped from %.1f to %.1f" % (target_x, safe_x))}
    {% endif %}
    {% if safe_y != target_y %}
        {action_respond_info("SAFETY: Y clamped from %.1f to %.1f" % (target_y, safe_y))}
    {% endif %}
    {% if safe_z != target_z %}
        {action_respond_info("SAFETY: Z clamped from %.1f to %.1f" % (target_z, safe_z))}
    {% endif %}
    
    G90
    G0 X{safe_x} Y{safe_y} Z{safe_z} F{speed}


####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
z_positions:
   -50, 18
   175, 398
   400, 18
points:
   50, 50
   175, 300
   300, 50
speed: 200
horizontal_move_z: 2
retries: 10
retry_tolerance: 0.0075


[gcode_macro Z_TILT_ADJUST]
description: IDM/Cartographer optimized 3Z leveling macro
rename_existing: _Z_TILT_ADJUST
gcode:
    SAVE_GCODE_STATE NAME=STATE_Z_TILT
    BED_MESH_CLEAR
    {% if not printer.z_tilt.applied %}
        _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1
    {% endif %}
    _Z_TILT_ADJUST horizontal_move_z=2
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT


####################################################################################
##                                 Front Center Purge
####################################################################################
#
#  KAMP-style purge with tunable variables
#  Adjust the variables below to tune purge behavior
#
####################################################################################
[gcode_macro FRONT_CENTER_PURGE]
description: KAMP-style front-center purge with tunable variables

# ==================== TUNING VARIABLES ====================
# Adjust these to tune your purge behavior
variable_purge_length: 20         # Length of purge LINE on bed (mm)
variable_purge_amount: 20         # Filament to extrude during line (mm)
variable_flow_rate: 15            # Flow rate (mm³/s) -
variable_purge_height: 0.8        # Nozzle height during purge (mm)
variable_tip_distance: 20         # Distance to prime filament tip (mm) - match PRINT_END retract
variable_wipe_distance: 20        # Rapid move distance to break string (mm)
variable_retract_speed: 20        # Retract speed (mm/s)
variable_retract_amount: 0.5      # Quick retract after purge (mm)
# ===========================================================

gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    {% set purge = printer["gcode_macro FRONT_CENTER_PURGE"] %}
    
    # Calculate purge move speed from flow rate
    # Formula: (flow_rate / 5.0) * 60 = mm/min
    # Example: 18 mm³/s = (18/5)*60 = 216 mm/min
    {% set purge_move_speed = (purge.flow_rate / 5.0) * 60 | float %}
    {% set retract_speed_mmmin = purge.retract_speed * 60 | float %}
    
    SAVE_GCODE_STATE NAME=front_purge_state
    
    M117 Purging...
    G90
    M83
    
    # Move to start of purge line (centered on purge_x)
    G1 X{pos.purge_x - (purge.purge_length / 2)} Y{pos.purge_y} F{speeds.park}
    G1 Z{purge.purge_height} F{speeds.slow}
    
    # Prime filament tip (accounts for PRINT_END retraction)
    G1 E{purge.tip_distance} F{purge_move_speed}
    
    # Draw purge line
    G1 X{pos.purge_x + (purge.purge_length / 2)} E{purge.purge_amount} F{purge_move_speed}
    
    # Retract and rapid wipe to break string
    G1 E-{purge.retract_amount} F{retract_speed_mmmin}
    G1 X{pos.purge_x + (purge.purge_length / 2) + purge.wipe_distance} F{speeds.travel_xy}
    
    # Z hop to clear
    G1 Z{purge.purge_height * 2 + 5} F{speeds.travel_z}
    
    RESTORE_GCODE_STATE NAME=front_purge_state
    M117 Purge complete


####################################################################################
##                                   Filament Handling
####################################################################################
[gcode_macro LOAD_FILAMENT]
description: Load filament with heating and purging
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set EXTRUDER_TEMP = params.TEMP|default(220)|float %}
    {% set LOAD_LENGTH = params.LENGTH|default(50)|float %}
    {% set PURGE_LENGTH = params.PURGE|default(25)|float %}

    SAVE_GCODE_STATE NAME=load_filament_state
    
    M117 Loading Filament...
    RESPOND MSG="Starting filament load procedure"
    
    {% if printer.extruder.temperature < EXTRUDER_TEMP - 5 %}
        M117 Heating extruder... 
        M109 S{EXTRUDER_TEMP}
    {% endif %}
    
    M83
    M117 Loading filament (slow)...
    G1 E30 F{speeds.extrude_slow}
    M117 Loading filament (fast)...
    G1 E{LOAD_LENGTH - 30} F{speeds.extrude_load}
    M117 Purging...
    G1 E{PURGE_LENGTH} F{speeds.extrude_slow}
    G1 E-1 F{speeds.extrude_load}
    
    M117 Filament loaded! 
    RESPOND MSG="Filament load complete"
    
    RESTORE_GCODE_STATE NAME=load_filament_state


[gcode_macro UNLOAD_FILAMENT]
description: Unload filament with heating
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set EXTRUDER_TEMP = params.TEMP|default(220)|float %}
    {% set UNLOAD_LENGTH = params.LENGTH|default(80)|float %}

    SAVE_GCODE_STATE NAME=unload_filament_state
    
    M117 Unloading Filament...
    RESPOND MSG="Starting filament unload procedure"
    
    {% if printer.extruder.temperature < EXTRUDER_TEMP - 5 %}
        M117 Heating extruder... 
        M109 S{EXTRUDER_TEMP}
    {% endif %}
    
    M83
    G1 E5 F{speeds.extrude_slow}
    G1 E-5 F{speeds.extrude_load}
    M117 Unloading...
    G1 E-{UNLOAD_LENGTH} F{speeds.extrude_load}
    
    M117 Filament unloaded!
    RESPOND MSG="Filament unload complete - please remove filament"
    
    RESTORE_GCODE_STATE NAME=unload_filament_state


####################################################################################
##                               Probe Calibration Macro
####################################################################################
[gcode_macro PROBECALIBRATE]
description: Move to center and start probe calibration
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}

    G28
    G0 X{pos.center_x} Y{pos.center_y} Z1 F{speeds.park}
    PROBE_CALIBRATE


####################################################################################
##                        Bed Leveling and Height Calibration
####################################################################################
[gcode_macro G32]
description: Full homing and leveling sequence
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    
    BED_MESH_CLEAR
    G28
    Z_TILT_ADJUST
    G28 Z
    G0 X{pos.center_x} Y{pos.center_y} Z30 F{speeds.park}


####################################################################################
##                                   PRINT_START
####################################################################################
[gcode_macro PRINT_START]
description: Print startup sequence with heating, leveling, meshing, and purge
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    {% set bed_temp = params.BED_TEMP|default(60)|float %}
    {% set extruder_temp = params.EXTRUDER_TEMP|default(200)|float %}
   
    M117 Starting print...
    M140 S{bed_temp}
     
    G28
    G90
    M83
    G92 E0
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    
    M190 S{bed_temp}
    M104 S150
    M109 S150
    
    
    Z_TILT_ADJUST
    G28 Z
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    CARTOGRAPHER_TOUCH_HOME
    
    G1 X{pos.purge_x} Y{pos.purge_y + 20} Z10 F{speeds.park}
   
    M104 S{extruder_temp}
    M109 S{extruder_temp}
    
    FRONT_CENTER_PURGE
    
    # G1 E-2 F{speeds.retract}
    G1 Z5 F{speeds.travel_z}
    
    M117 Printing... 


####################################################################################
##                                   PRINT_END
####################################################################################
[gcode_macro PRINT_END]
description: Print completion - drop bed, then park toolhead
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    {% set th = printer.toolhead %}

    SAVE_GCODE_STATE NAME=STATE_PRINT_END
   
    M400
    G92 E0
    G1 E-20 F{speeds.retract_long}
   
    TURN_OFF_HEATERS
   
    G90
    
    # Step 1: Drop bed to max Z first (clears the print)
    G0 Z{pos.park_z_max} F{speeds.travel_z_fast}
   
    # Step 2: Quick move away from print to break strings
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    G0 X{x_safe} Y{y_safe} F{speeds.travel_xy_max}
    
    # Step 3: Park toolhead at rear center
    G0 X{pos.park_x} Y{pos.park_y} F{speeds.park}
    
    M107
    SET_FAN_SPEED FAN=fan0 SPEED=0
    SET_FAN_SPEED FAN=fan2 SPEED=0
    SET_FAN_SPEED FAN=fan3 SPEED=0
    
    BED_MESH_CLEAR

    
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0
    M117 Print Complete!
    
####################################################################################
##                                     PAUSE
####################################################################################
[gcode_macro PAUSE]
description: Pause the running print
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    {% set x_park = pos.bed_x - pos.safe_margin %}
    {% set y_park = pos.bed_y - pos.safe_margin %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set z_safe = [pos.safe_z_pause, max_z - act_z]|min %}

    PAUSE_BASE

    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-{E} F{speeds.retract}
    {% else %}
        {action_respond_info("Extruder not hot enough to retract")}
    {% endif %}
    
    {% if "xyz" in printer.toolhead.homed_axes %}
        G1 Z{z_safe} F{speeds.slow}
        G90
        G1 X{x_park} Y{y_park} F{speeds.park}
    {% else %}
        {action_respond_info("Printer not homed - cannot park")}
    {% endif %}

    M117 Paused


####################################################################################
##                                     RESUME
####################################################################################
[gcode_macro RESUME]
description: Resume the paused print
rename_existing: RESUME_BASE
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    
    {% if 'VELOCITY' in params|upper %}
        {% set get_params = ('VELOCITY=' + params.VELOCITY) %}
    {% else %}
        {% set get_params = "" %}
    {% endif %}
    
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G91
        G1 E{E} F{speeds.retract}
    {% else %}
        {action_respond_info("Extruder not hot enough to prime")}
    {% endif %}
    
    M117 Resuming...
    RESUME_BASE {get_params}


####################################################################################
##                                  CANCEL_PRINT
####################################################################################
[gcode_macro CANCEL_PRINT]
description: Cancel the running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}

    M117 Cancelling... 
    G28 Y
    _TOOLHEAD_PARK_PAUSE_CANCEL
    TURN_OFF_HEATERS
    CANCEL_PRINT_BASE
    
    SET_FAN_SPEED FAN=fan0 SPEED=0
    SET_FAN_SPEED FAN=fan2 SPEED=0
    SET_FAN_SPEED FAN=fan3 SPEED=0
    

    M117 Print Cancelled


####################################################################################
##                              Toolhead Park
####################################################################################
[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Park toolhead for pause or cancel operations
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    {% set pos = printer["gcode_macro _GLOBAL_POSITIONS"] %}
    {% set z_park = [printer.toolhead.position.z + pos.park_z_hop, pos.park_z_max]|min %}
    
    {% if "xyz" in printer.toolhead.homed_axes %}
        G90
        G1 Z{z_park} F{speeds.travel_z}
        G1 X{pos.park_x} Y{pos.park_y} F{speeds.park}
    {% else %}
        {action_respond_info("Printer not homed - cannot park")}
    {% endif %}


####################################################################################
##                                  DATA_SAMPLE
####################################################################################
[gcode_macro DATA_SAMPLE]
description: Cartographer temperature differential calibration routine
gcode:
    {% set speeds = printer["gcode_macro _GLOBAL_SPEEDS"] %}
    
    G90
    M106 S255
    RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
    M117 Waiting for Coil to cool to 40
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40
    
    RESPOND TYPE=command MSG='Starting Phase 1 of 4'
    M117 Starting Phase 1 of 4
    M106 S0
    G28
    G0 Z1 F{speeds.travel_z}
    M104 S250
    M140 S110
    G4 P1000
    CARTOGRAPHER_STREAM FILENAME=data1
    M117 Waiting for Coil to heat to 70
    RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
    CARTOGRAPHER_STREAM FILENAME=data1
    M104 S0
    M140 S0
    M106 S255
    G0 Z80 F{speeds.travel_z_fast}
    RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
    M117 Waiting for Coil to cool to 40
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40

    M117 Starting Phase 2 of 4
    RESPOND TYPE=command MSG='Starting Phase 2 of 4'
    M106 S0
    G28 Z0
    G0 Z2 F{speeds.travel_z}
    M104 S250
    M140 S110
    G4 P1000
    CARTOGRAPHER_STREAM FILENAME=data2
    M117 Waiting for Coil to heat to 70
    RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
    CARTOGRAPHER_STREAM FILENAME=data2
    M104 S0
    M140 S0
    M106 S255
    G0 Z80 F{speeds.travel_z_fast}
    RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
    M117 Waiting for Coil to cool to 40
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40

    M117 Starting Phase 3 of 4
    RESPOND TYPE=command MSG='Starting Phase 3 of 4'
    M106 S0
    G28 Z0
    G0 Z3 F{speeds.travel_z}
    M104 S250
    M140 S110
    G4 P1000
    CARTOGRAPHER_STREAM FILENAME=data3
    M117 Waiting for Coil to heat to 70
    RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
    CARTOGRAPHER_STREAM FILENAME=data3
    M104 S0
    M140 S0
    M106 S255
    G0 Z80 F{speeds.travel_z_fast}
    M117 Waiting for Coil to cool to 40
    RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40

    M117 Starting Phase 4 of 4
    RESPOND TYPE=command MSG='Starting Phase 4 of 4'
    M106 S0
    G28 Z0
    G0 Z5 F{speeds.travel_z}
    M104 S250
    M140 S110
    G4 P1000
    CARTOGRAPHER_STREAM FILENAME=data4
    M117 Waiting for Coil to heat to 70
    RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
    TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
    CARTOGRAPHER_STREAM FILENAME=data4
    M104 S0
    M140 S0
    RESPOND TYPE=command MSG='Testing complete'
    M117 Testing complete! 



####################################################################################
##                                  Cartographer Macros
####################################################################################
#       General macros
# CARTOGRAPHER_TOUCH_PROBE

# CARTOGRAPHER_TOUCH_HOME

# CARTOGRAPHER_SCAN_MODEL LOAD=<model> REMOVE=<model>

# CARTOGRAPHER_TOUCH_MODEL LOAD=<model> REMOVE=<model>

#     Calibration macros
# CARTOGRAPHER_SCAN_CALIBRATE MODEL=default METHOD=manual|touch

# CARTOGRAPHER_ESTIMATE_BACKLASH ITERATIONS=10 DELTA=0.2 [CALIBRATE=1]

# CARTOGRAPHER_TOUCH_CALIBRATE MODEL=default SPEED=2 START=500 MAX=3000 SUCCESS_RATE=0.95
# X-axis twist compensation
# CARTOGRAPHER_AXIS_TWIST_COMPENSATION AXIS=X USE_TOUCH_BOUNDARIES=1 SAMPLE_COUNT=5 START=30 END=320 LINE=150
# Y-axis twist compensation
# CARTOGRAPHER_AXIS_TWIST_COMPENSATION AXIS=Y USE_TOUCH_BOUNDARIES=1 SAMPLE_COUNT=5 START=80 END=297 LINE=175

# CARTOGRAPHER_TEMPERATURE_CALIBRATE BED_TEMP=90 MIN_TEMP=40 MAX_TEMP=70 Z_SPEED=5

#   Troubleshooting macros
# CARTOGRAPHER_SCAN_ACCURACY SAMPLES=100 [READINGS=20]

# PROBE_ACCURACY SAMPLES=10

# CARTOGRAPHER_TOUCH_ACCURACY SAMPLES=5 LIFT_SPEED=5 SAMPLE_RETRACT_DIST=2

# CARTOGRAPHER_STREAM ACTION=start|stop|cancel|status [FILE="~/stream.csv"]