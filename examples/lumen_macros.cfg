# LUMEN Macro Examples
#
# Add these to your printer.cfg to enable convenient LUMEN control via macros.
# These macros use the LUMEN API endpoints for testing and control.

[gcode_macro LUMEN_RELOAD]
description: Reload LUMEN configuration without restarting Moonraker
gcode:
    {action_call_remote_method("POST",
                               uri="/server/lumen/reload")}
    RESPOND MSG="LUMEN configuration reloaded"

[gcode_macro LUMEN_TEST]
description: Test a specific printer state (e.g., LUMEN_TEST STATE=heating)
gcode:
    {% set state = params.STATE|default("idle")|lower %}
    {action_call_remote_method("POST",
                               uri="/server/lumen/test_event",
                               params={"event": state})}
    RESPOND MSG="LUMEN testing {state} state"

[gcode_macro LUMEN_SET]
description: Override a group's effect (e.g., LUMEN_SET GROUP=left EFFECT=pulse COLOR=red DURATION=10)
gcode:
    {% set group = params.GROUP|default("")|lower %}
    {% set effect = params.EFFECT|default("solid")|lower %}
    {% set color = params.COLOR|default("white")|lower %}
    {% set duration = params.DURATION|default(0)|float %}

    {% if group == "" %}
        RESPOND MSG="Error: GROUP parameter required"
    {% else %}
        {action_call_remote_method("POST",
                                   uri="/server/lumen/set_group",
                                   params={"group": group,
                                          "effect": effect,
                                          "color": color,
                                          "duration": duration})}
        {% if duration > 0 %}
            RESPOND MSG="LUMEN: {group} set to {effect} {color} for {duration}s"
        {% else %}
            RESPOND MSG="LUMEN: {group} set to {effect} {color}"
        {% endif %}
    {% endif %}

# ============================================================
# v1.7.0 - Test Mode Macros
# ============================================================

[gcode_macro LUMEN_TEST_START]
description: Enter test mode for cycling through states and effects
gcode:
    {action_call_remote_method("POST",
                               uri="/server/lumen/test/start")}
    RESPOND MSG="LUMEN test mode enabled - use NEXT/PREV macros to cycle"

[gcode_macro LUMEN_TEST_STOP]
description: Exit test mode and return to normal operation
gcode:
    {action_call_remote_method("POST",
                               uri="/server/lumen/test/stop")}
    RESPOND MSG="LUMEN test mode disabled"

[gcode_macro LUMEN_TEST_NEXT_STATE]
description: Cycle to next printer state in test mode
gcode:
    {action_call_remote_method("POST",
                               uri="/server/lumen/test/next_state")}
    RESPOND MSG="LUMEN cycling to next state"

[gcode_macro LUMEN_TEST_PREV_STATE]
description: Cycle to previous printer state in test mode
gcode:
    {action_call_remote_method("POST",
                               uri="/server/lumen/test/prev_state")}
    RESPOND MSG="LUMEN cycling to previous state"

[gcode_macro LUMEN_TEST_NEXT_EFFECT]
description: Cycle to next effect in test mode (e.g., LUMEN_TEST_NEXT_EFFECT GROUP=left)
gcode:
    {% set group = params.GROUP|default("")|lower %}
    {% if group == "" %}
        {action_call_remote_method("POST",
                                   uri="/server/lumen/test/next_effect")}
    {% else %}
        {action_call_remote_method("POST",
                                   uri="/server/lumen/test/next_effect",
                                   params={"group": group})}
    {% endif %}
    RESPOND MSG="LUMEN cycling to next effect"

[gcode_macro LUMEN_TEST_PREV_EFFECT]
description: Cycle to previous effect in test mode (e.g., LUMEN_TEST_PREV_EFFECT GROUP=left)
gcode:
    {% set group = params.GROUP|default("")|lower %}
    {% if group == "" %}
        {action_call_remote_method("POST",
                                   uri="/server/lumen/test/prev_effect")}
    {% else %}
        {action_call_remote_method("POST",
                                   uri="/server/lumen/test/prev_effect",
                                   params={"group": group})}
    {% endif %}
    RESPOND MSG="LUMEN cycling to previous effect"

# ============================================================
# Example usage in your macros:
# ============================================================
#
# [gcode_macro PRINT_START]
# gcode:
#     # ... your existing PRINT_START code ...
#     LUMEN_SET GROUP=chamber EFFECT=solid COLOR=white  # Set chamber to bright white for printing
#     # ... rest of your code ...
#
# [gcode_macro PRINT_END]
# gcode:
#     # ... your existing PRINT_END code ...
#     LUMEN_RELOAD  # Reload config to return to normal state cycle
#     # ... rest of your code ...
#
# ============================================================
# Test Mode Usage:
# ============================================================
#
# 1. Enter test mode:
#    LUMEN_TEST_START
#
# 2. Cycle through printer states (idle, heating, printing, etc.):
#    LUMEN_TEST_NEXT_STATE
#    LUMEN_TEST_PREV_STATE
#
# 3. Cycle through effects on a specific group:
#    LUMEN_TEST_NEXT_EFFECT GROUP=left
#    LUMEN_TEST_PREV_EFFECT GROUP=left
#
# 4. Exit test mode:
#    LUMEN_TEST_STOP
